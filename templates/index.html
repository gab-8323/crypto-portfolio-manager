<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Load Chart.js early for initialization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- 1. Ticker Tape -->
    <div class="ticker-wrap">
        <div class="ticker">
            {% for item in portfolio %}
            <div class="ticker__item">
                {{ item.symbol|upper }} <span
                    class="{{ 'positive-change' if item.change_24h >= 0 else 'negative-change' }}">{{
                    "{:+.2f}%".format(item.change_24h) }}</span>
            </div>
            {% endfor %}
            <!-- Duplicate for seamless loop if few items -->
            {% for item in portfolio %}
            <div class="ticker__item">
                {{ item.symbol|upper }}
                <span class="{{ 'positive-change' if item.change_24h >= 0 else 'negative-change' }}">
                    {{ "{:+.2f}%".format(item.change_24h) }}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="container" style="margin-top: 20px;">
        <header class="header-section">
            <h1>Crypto Portfolio Manager</h1>
            <div class="user-info">
                <span>Welcome, <strong>{{ username }}</strong>!</span>
                <a href="/history" class="auth-link" style="margin-right: 15px;">History</a>
                <a href="/logout" class="btn-logout" aria-label="Logout from account">Logout</a>
            </div>
        </header>

        <!-- Alerts Banner -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}"
            style="text-align:center; padding: 10px; background: #333; color: #fff; margin-bottom: 20px;">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Settings Bar -->
        <section class="card" aria-labelledby="settings-heading" style="padding: 15px; margin-bottom: 20px;">
            <h2 id="settings-heading" class="sr-only">Settings</h2>
            <div
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <!-- Currency Switcher -->
                <form action="/set_currency" method="POST" class="form-inline" style="margin:0;">
                    <label for="currency-select" style="margin-right: 10px;">Currency:</label>
                    <select id="currency-select" name="currency" onchange="this.form.submit()" style="padding: 5px;">
                        <option value="USD" {{ 'selected' if current_currency=='USD' else '' }}>USD ($)</option>
                        <option value="EUR" {{ 'selected' if current_currency=='EUR' else '' }}>EUR (€)</option>
                        <option value="GBP" {{ 'selected' if current_currency=='GBP' else '' }}>GBP (£)</option>
                        <option value="INR" {{ 'selected' if current_currency=='INR' else '' }}>INR (₹)</option>
                        <option value="JPY" {{ 'selected' if current_currency=='JPY' else '' }}>JPY (¥)</option>
                    </select>
                </form>

                <!-- Auto-Notifications are now fully automatic -->
                <div style="display:flex; gap:10px;">
                    <button onclick="toggleMarketExplorer()" class="btn-view"
                        style="background: var(--gradient-main); color: #000; border: none; font-weight: bold;">Explore
                        Market</button>
                    <button onclick="toggleNews(event)" class="btn-view"
                        style="background: var(--accent-secondary); color: white; border: none;">Show Market
                        News</button>
                </div>
            </div>
        </section>

        <!-- Summary Section -->
        <main>
            <section class="card summary-card" aria-labelledby="balance-heading">
                <!-- Using a flex container for stats -->
                <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap;">
                    <div>
                        <h2 id="balance-heading" style="border:none; margin-bottom:5px;">Total Balance</h2>
                        <div id="total-balance-display" class="total-balance" aria-live="polite">
                            {{ currency_symbol }}{{ "{:,.2f}".format(total_value) }}
                        </div>
                    </div>
                    <div>
                        <h2 style="border:none; margin-bottom:5px;">Total P/L</h2>
                        <div id="total-pl-display"
                            class="total-balance {{ 'positive-change' if total_pl >= 0 else 'negative-change' }}"
                            style="font-size: 2em;">
                            {{ currency_symbol }}{{ "{:,.2f}".format(total_pl) }}
                            <small>({{ "{:+.2f}%".format(total_roi) }})</small>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Market Trends Section -->
            <section class="card" aria-labelledby="trends-heading">
                <div class="section-header-inline">
                    <h2 id="trends-heading">7 Day Price History</h2>
                    <button id="reset-chart-btn" class="btn-reset" onclick="resetChart()" style="display:none;"
                        aria-label="Show all coins">Show All</button>
                </div>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <canvas id="trendChart" aria-label="7 Day Price Trend Chart" role="img"></canvas>
                    </div>
                </div>
            </section>

            <!-- Charts Section -->
            <section class="card" aria-labelledby="analysis-heading">
                <h2 id="analysis-heading">Portfolio Analysis</h2>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <canvas id="distributionChart" aria-label="Portfolio Distribution Pie Chart"
                            role="img"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="valueChart" aria-label="Asset Value Bar Chart" role="img"></canvas>
                    </div>
                </div>
            </section>


            <!-- Market Grid (Stock Market Vibe) -->
            <section aria-labelledby="market-heading" style="margin-bottom: 30px;">
                <h2 id="market-heading">Market Watch</h2>
                <div class="market-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    {% for item in portfolio %}
                    <div class="card market-card" data-symbol="{{ item.symbol }}"
                        style="padding: 20px; margin-bottom: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h3 style="margin: 0; font-size: 1.2em;">{{ item.symbol|upper }}</h3>
                                <small style="color: #888;">{{ item.name }}</small>
                            </div>
                            {% if item.image %}
                            <img src="{{ item.image }}" alt="" style="width: 30px; height: 30px; border-radius: 50%;">
                            {% endif %}
                        </div>
                        <div style="margin: 15px 0;">
                            <div class="market-price" style="font-size: 1.5em; font-weight: bold;">
                                {{ currency_symbol }}{{ "{:,.2f}".format(item.price) }}
                            </div>
                            <div
                                class="market-change {{ 'positive-change' if item.change_24h >= 0 else 'negative-change' }}">
                                {{ "{:+.2f}%".format(item.change_24h) }}
                            </div>
                        </div>
                        <!-- Mini Sparkline Canvas -->
                        <div style="height: 50px; width: 100%;">
                            <canvas id="sparkline-{{ item.symbol }}" height="50"></canvas>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section> <!-- Fixed: Closing Market Watch Section -->

            <!-- Market Explorer Section (Dynamic) -->
            <section id="explorer-section" class="card" aria-labelledby="explorer-heading"
                style="display: none; border: 1px solid var(--accent-primary);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="explorer-heading" style="margin: 0;">Market Explorer (Top 50)</h2>
                    <button onclick="toggleMarketExplorer()" class="btn-delete"
                        style="padding: 5px 15px; background: #444; color: white;">Close</button>
                </div>
                <div id="explorer-grid" class="market-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <p style="color: var(--text-secondary); text-align: center; grid-column: 1/-1;">Loading market
                        data...</p>
                </div>
            </section>

            <!-- Management Section -->
            <section class="card" aria-labelledby="manage-heading">
                <h2 id="manage-heading" style="text-align: center; margin-bottom: 25px;">Manage Assets</h2>

                <!-- Add Coin Form -->
                <form action="/add" method="POST" class="form-inline" id="trade-form">
                    <select name="trade_type" id="trade-type-select" onchange="updateTradeUI()" style="width: auto;">
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>

                    <label for="symbol-input" class="sr-only">Coin Symbol</label>
                    <input type="text" id="symbol-input" name="symbol" list="available-coins"
                        placeholder="Coin Name (e.g. bitcoin)" required aria-required="true" autocomplete="off">
                    <datalist id="available-coins">
                        {% for coin in all_coins %}
                        <option value="{{ coin.id }}">{{ coin.name }} ({{ coin.symbol|upper }})</option>
                        {% endfor %}
                    </datalist>

                    <label for="buy-price-input" class="sr-only" id="price-label">Buy Price</label>
                    <input type="number" id="buy-price-input" name="buy_price" step="any" placeholder="Price ($)"
                        aria-label="Price per coin">

                    <label for="quantity-input" class="sr-only">Quantity</label>
                    <input type="number" id="quantity-input" name="quantity" step="any" placeholder="Quantity" required
                        aria-required="true">

                    <button type="submit" class="btn-add" id="trade-btn">Execute Buy</button>
                </form>

                <script>
                    function updateTradeUI() {
                        const type = document.getElementById('trade-type-select').value;
                        const btn = document.getElementById('trade-btn');
                        const label = document.getElementById('price-label');

                        if (type === 'SELL') {
                            btn.innerText = 'Execute Sell';
                            btn.style.background = 'var(--accent-secondary)'; // Reddish for sell
                            btn.style.boxShadow = '0 4px 15px rgba(255, 0, 80, 0.3)';
                            label.innerText = 'Sell Price';
                        } else {
                            btn.innerText = 'Execute Buy';
                            btn.style.background = 'var(--gradient-main)';
                            btn.style.boxShadow = '0 4px 15px rgba(0, 242, 234, 0.3)';
                            label.innerText = 'Buy Price';
                        }
                    }

                    function prepSell(symbol, price) {
                        const typeSelect = document.getElementById('trade-type-select');
                        const symbolInput = document.getElementById('symbol-input');
                        const priceInput = document.getElementById('buy-price-input');
                        const quantityInput = document.getElementById('quantity-input');

                        typeSelect.value = 'SELL';
                        updateTradeUI();
                        symbolInput.value = symbol;
                        priceInput.value = price;
                        quantityInput.focus();

                        document.getElementById('manage-heading').scrollIntoView({ behavior: 'smooth' });
                    }
                </script>

                <!-- Portfolio Table -->
                <div class="sub-header">Your Current Asset Holdings</div>
                <div class="table-responsive">
                    <table>
                        <caption class="sr-only">Your current crypto assets holdings</caption>
                        <thead>
                            <tr>
                                <th scope="col">Coin</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Avg Buy Price</th>
                                <th scope="col">Current Price</th>
                                <th scope="col">P/L ({{ currency_symbol }})</th>
                                <th scope="col">ROI</th>
                                <th scope="col">Total Value</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in portfolio %}
                            <tr data-symbol="{{ item.symbol }}">
                                <td>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        {% if item.image %}
                                        <img src="{{ item.image }}" alt=""
                                            style="width:20px; height:20px; border-radius:50%;">
                                        {% endif %}
                                        {{ item.name }}
                                        <small style="color:#888;">{{ item.symbol|upper }}</small>
                                    </div>
                                </td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ currency_symbol }}{{ "{:,.2f}".format(item.avg_buy_price) }}</td>
                                <td>
                                    {{ currency_symbol }}{{ "{:,.2f}".format(item.price) }}
                                    <br>
                                    <small
                                        class="{{ 'positive-change' if item.change_24h >= 0 else 'negative-change' }}">
                                        {{ "{:+.2f}%".format(item.change_24h) }}
                                    </small>
                                </td>
                                <td class="{{ 'positive-change' if item.pl >= 0 else 'negative-change' }}">
                                    {{ currency_symbol }}{{ "{:,.2f}".format(item.pl) }}
                                </td>
                                <td class="{{ 'positive-change' if item.roi >= 0 else 'negative-change' }}">
                                    {{ "{:+.2f}%".format(item.roi) }}
                                </td>
                                <td>{{ currency_symbol }}{{ "{:,.2f}".format(item.value) }}</td>
                                <td class="action-cell">
                                    <button class="btn-view" data-symbol="{{ item.symbol }}"
                                        onclick="filterChart(this.dataset.symbol)"
                                        aria-label="View graph for {{ item.symbol }}">View Graph</button>
                                    <button class="btn-view sell-btn" data-symbol="{{ item.symbol }}"
                                        data-price="{{ item.price|default(0) }}"
                                        onclick="prepSell(this.dataset.symbol, parseFloat(this.dataset.price))"
                                        style="background: var(--accent-secondary); color: white; border: none;"
                                        aria-label="Sell {{ item.symbol }}">Sell</button>
                                    <a href="/delete/{{ item.id }}" class="btn-delete"
                                        onclick="return confirm('Are you sure you want to remove this asset?')"
                                        aria-label="Remove {{ item.symbol }}">Remove</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Market News Section (At Last) -->
            <section id="news-section" class="card" aria-labelledby="news-heading" style="display: none;">
                <h2 id="news-heading">Market News</h2>
                <div class="news-list">
                    {% if news %}
                    {% for item in news %}
                    <div class="news-item">
                        <a href="{{ item.link }}" target="_blank" class="news-link">{{ item.title }}</a>
                        <div class="news-meta">Source: CoinTelegraph • {{ item.date }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p style="color: var(--text-secondary);">No recent news available.</p>
                    {% endif %}
                </div>
            </section>
        </main>
    </div>

    <!-- Data passed from Flask -->
    <script id="portfolio-data" type="application/json">
        {{ portfolio_json | safe }}
    </script>

    <div id="toast-container"
        style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;">
    </div>

    <script>
        // --- Real-time Dashboard Logic ---
        function requestNotificationPermission() {
            if ("Notification" in window) {
                Notification.requestPermission();
            }
        }

        // Update every 30 seconds for faster feedback
        setInterval(updateDashboard, 30000);

        async function updateDashboard() {
            try {
                const response = await fetch('/api/dashboard_data');
                if (response.ok) {
                    const data = await response.json();
                    const currency = data.currency_symbol;
                    const formatter = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                    // 1. Update Totals (Using specific IDs)
                    const totalBalEl = document.getElementById('total-balance-display');
                    const totalPlEl = document.getElementById('total-pl-display');

                    if (totalBalEl) totalBalEl.innerText = currency + formatter.format(data.total_value);

                    if (totalPlEl) {
                        const plSign = data.total_pl >= 0 ? '+' : '';
                        totalPlEl.innerHTML = `
                            ${currency}${formatter.format(data.total_pl)}
                            <small>(${plSign}${data.total_roi.toFixed(2)}%)</small>
                        `;
                        totalPlEl.className = 'total-balance ' + (data.total_pl >= 0 ? 'positive-change' : 'negative-change');
                    }

                    // 2. Update Table Rows AND Market Grid Cards
                    data.portfolio.forEach(coin => {
                        // A. Table Row
                        const row = document.querySelector(`tr[data-symbol="${coin.symbol}"]`);
                        if (row) {
                            // Update Table Cells
                            const qtyCell = row.children[1];
                            const avgPriceCell = row.children[2];
                            const currentPriceCell = row.children[3];
                            const plAmountCell = row.children[4];
                            const roiCell = row.children[5];
                            const totalValueCell = row.children[6];

                            const changeSign = coin.change_24h >= 0 ? '+' : '';
                            const changeClass = coin.change_24h >= 0 ? 'positive-change' : 'negative-change';

                            qtyCell.innerText = coin.quantity;
                            avgPriceCell.innerText = currency + formatter.format(coin.avg_buy_price);
                            currentPriceCell.innerHTML = `
                                ${currency}${formatter.format(coin.price)}
                                <br>
                                <small class="${changeClass}">${changeSign}${coin.change_24h.toFixed(2)}%</small>
                            `;

                            // Update Sell Button Price (live sync)
                            const sellBtn = row.querySelector('.sell-btn');
                            if (sellBtn) {
                                sellBtn.setAttribute('data-price', coin.price);
                            }

                            plAmountCell.className = coin.pl >= 0 ? 'positive-change' : 'negative-change';
                            plAmountCell.innerText = currency + formatter.format(coin.pl);

                            roiCell.className = coin.roi >= 0 ? 'positive-change' : 'negative-change';
                            roiCell.innerText = (coin.roi >= 0 ? '+' : '') + coin.roi.toFixed(2) + '%';

                            totalValueCell.innerText = currency + formatter.format(coin.value);
                        }

                        // B. Market Grid Card
                        const card = document.querySelector(`.market-card[data-symbol="${coin.symbol}"]`);
                        if (card) {
                            const priceEl = card.querySelector('.market-price');
                            const changeEl = card.querySelector('.market-change');

                            priceEl.innerText = currency + formatter.format(coin.price);
                            changeEl.innerText = (coin.change_24h >= 0 ? '+' : '') + coin.change_24h.toFixed(2) + '%';

                            // Visual Update for Change Color
                            changeEl.className = 'market-change ' + (coin.change_24h >= 0 ? 'positive-change' : 'negative-change');
                        }
                    });

                    // 3. Update Charts
                    updateCharts(data.portfolio, currency);

                    // 3. Notifications (Staggered)
                    if (data.notifications && data.notifications.length > 0) {
                        data.notifications.forEach((msg, index) => {
                            setTimeout(() => {
                                showNotification(msg);
                            }, index * 2000); // Faster stagger (2s) for stacking effect
                        });
                    }
                }
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        function updateCharts(portfolio, currency) {
            // Map new data
            const labels = portfolio.map(c => c.name);
            const values = portfolio.map(c => c.value);

            // Update Distribution Chart
            // Assuming global variable from below (chart instances need to be global)
            // We will modify the init code below to ensure they are accessible window.distChart etc.
            if (window.distChart) {
                window.distChart.data.labels = labels;
                window.distChart.data.datasets[0].data = values;
                window.distChart.update();
            }

            // Update Value Chart
            if (window.valueChart) {
                window.valueChart.data.labels = labels;
                window.valueChart.data.datasets[0].data = values;
                window.valueChart.data.datasets[0].label = `Total Value (${currency})`;
                window.valueChart.update();
            }

            // Trend chart is complex (sparklines), we'll skip live updating sparkline history
            // per poll for MVP to avoid data mismatches, but we can update the color if users want.
        }

        function showNotification(message) {
            // 1. Browser Notification
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("Crypto Price Alert", { body: message, icon: "{{ url_for('static', filename='icon.png') }}" });
            }

            // 2. In-App Toast (Stacking)
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'alert alert-info';
            // Custom style for stacking
            toast.style.background = '#333';
            toast.style.color = '#fff';
            toast.style.padding = '15px';
            toast.style.borderRadius = '8px';
            toast.style.boxShadow = '0 4px 6px rgba(0,0,0,0.3)';
            toast.innerText = message;
            toast.style.minWidth = '250px';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s ease-in';

            container.appendChild(toast);

            // Fade in
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
            });

            // Remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500); // Wait for fade out
            }, 5000);
        }

        // Request on load
        document.addEventListener('DOMContentLoaded', requestNotificationPermission);


        // --- Chart & Interaction Logic ---
        let trendChart;
        // Make other charts global for update function
        window.distChart = null;
        window.valueChart = null;

        let portfolioData;

        document.addEventListener('DOMContentLoaded', function () {
            const rawData = document.getElementById('portfolio-data').textContent;
            try {
                portfolioData = JSON.parse(rawData);
            } catch (e) {
                console.error("Error parsing portfolio", e);
                portfolioData = [];
            }

            const labels = portfolioData.map(item => item.name || item.symbol.toUpperCase());
            const values = portfolioData.map(item => item.value);

            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                '#E7E9ED', '#71B37C', '#EC932F', '#526958'
            ];

            // Initialize Charts even if empty (but with default state)
            const demoLabels = labels.length > 0 ? labels : ['No Assets'];
            const demoValues = values.length > 0 ? values : [0.001];
            const demoBg = labels.length > 0 ? backgroundColors : ['#333'];

            // Common Options for Dark Theme
            Chart.defaults.color = '#ffffff';
            Chart.defaults.borderColor = '#444444';

            // 1. Distribution Pie Chart
            const ctxPie = document.getElementById('distributionChart').getContext('2d');
            window.distChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: demoLabels,
                    datasets: [{
                        data: demoValues,
                        backgroundColor: demoBg,
                        borderWidth: 0,
                        borderColor: '#1a1a1a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#fff' } }
                    }
                }
            });

            // 3. Value Chart (Bar)
            const ctxValue = document.getElementById('valueChart').getContext('2d');
            window.valueChart = new Chart(ctxValue, {
                type: 'bar',
                data: {
                    labels: portfolioData.map(c => c.name),
                    datasets: [{
                        label: 'Total Value ({{ currency_symbol }})',
                        data: portfolioData.map(c => c.value),
                        backgroundColor: '#4BC0C0',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#fff' } },
                        x: { grid: { display: false }, ticks: { color: '#fff' } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // 3. 7-Day Trend Line Chart (Sparklines)
            const ctxTrend = document.getElementById('trendChart').getContext('2d');

            // Prepare datasets for each coin
            const trendDatasets = portfolioData.map((item, index) => {
                return {
                    label: item.symbol.charAt(0).toUpperCase() + item.symbol.slice(1),
                    symbolKey: item.symbol, // Custom key for filtering
                    data: item.sparkline, // Array of prices
                    borderColor: backgroundColors[index % backgroundColors.length],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    tension: 0.4,
                    fill: false,
                    hidden: false
                };
            });

            // Create a dummy labels array
            const maxPoints = Math.max(...portfolioData.map(i => i.sparkline ? i.sparkline.length : 0));
            const trendLabels = Array.from({ length: maxPoints }, (_, i) => i);

            trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: trendDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'nearest', intersect: false, axis: 'x' },
                    plugins: {
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                title: () => '',
                                label: function (context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        },
                        legend: { display: true, position: 'bottom' }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false, grid: { display: false } }
                    }
                }
            });

            // --- Initialize Mini Sparklines for Grid ---
            portfolioData.forEach((item, index) => {
                const canvasId = `sparkline-${item.symbol}`;
                const miniCtx = document.getElementById(canvasId);
                if (miniCtx) {
                    new Chart(miniCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({ length: item.sparkline ? item.sparkline.length : 10 }, (_, i) => i),
                            datasets: [{
                                data: item.sparkline,
                                borderColor: item.change_24h >= 0 ? '#00f2ea' : '#ff0050', // Cyan/Pink based on performance
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true,
                                backgroundColor: item.change_24h >= 0 ? 'rgba(0, 242, 234, 0.1)' : 'rgba(255, 0, 80, 0.1)',
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { enabled: false } },
                            scales: {
                                x: { display: false },
                                y: { display: false }
                            }
                        }
                    });
                }
            });

        });

        // Global functions for interactivity
        function filterChart(symbol) {
            if (!trendChart) return;

            trendChart.data.datasets.forEach(ds => {
                if (ds.symbolKey === symbol) {
                    ds.hidden = false;
                } else {
                    ds.hidden = true;
                }
            });
            trendChart.update();

            document.getElementById('reset-chart-btn').style.display = 'inline-block';
            document.getElementById('trends-heading').innerText = symbol.charAt(0).toUpperCase() + symbol.slice(1) + ' History';
            document.getElementById('trends-heading').scrollIntoView({ behavior: 'smooth' });
        }

        function resetChart() {
            if (!trendChart) return;

            trendChart.data.datasets.forEach(ds => {
                ds.hidden = false;
            });
            trendChart.update();

            document.getElementById('reset-chart-btn').style.display = 'none';
            document.getElementById('trends-heading').innerText = '7 Day Price History';
        }

        async function toggleMarketExplorer() {
            const section = document.getElementById('explorer-section');
            const grid = document.getElementById('explorer-grid');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                section.scrollIntoView({ behavior: 'smooth' });

                // Fetch if empty or logic
                try {
                    const response = await fetch('/api/market_explorer');
                    const data = await response.json();
                    renderMarketExplorer(data);
                } catch (e) {
                    grid.innerHTML = `<p style="color: #ff0050; grid-column: 1/-1;">Error loading market data. Please try again later.</p>`;
                }
            } else {
                section.style.display = 'none';
            }
        }

        function renderMarketExplorer(data) {
            const grid = document.getElementById('explorer-grid');
            grid.innerHTML = ''; // Clear loader

            if (!data || data.length === 0) {
                grid.innerHTML = `<p style="color: var(--text-secondary); grid-column: 1/-1;">No market data available.</p>`;
                return;
            }

            data.forEach(coin => {
                const card = document.createElement('div');
                card.className = 'card market-card';
                card.style.padding = '20px';

                const isPositive = coin.price_change_percentage_24h >= 0;
                const changeClass = isPositive ? 'positive-change' : 'negative-change';
                const chartColor = isPositive ? '#00f2ea' : '#ff0050';
                const chartBg = isPositive ? 'rgba(0, 242, 234, 0.1)' : 'rgba(255, 0, 80, 0.1)';

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.2em;">${coin.symbol.toUpperCase()}</h3>
                            <small style="color: #888;">${coin.name}</small>
                        </div>
                        <img src="${coin.image}" alt="" style="width: 30px; height: 30px; border-radius: 50%;">
                    </div>
                    <div style="margin: 15px 0;">
                        <div style="font-size: 1.5em; font-weight: bold;">{{ currency_symbol }}${coin.current_price.toLocaleString()}</div>
                        <div class="${changeClass}">${coin.price_change_percentage_24h.toFixed(2)}%</div>
                    </div>
                    <div style="height: 50px; width: 100%;">
                        <canvas id="explorer-spark-${coin.id}" height="50"></canvas>
                    </div>
                    <button onclick="document.getElementById('symbol-input').value='${coin.id}'; document.getElementById('manage-heading').scrollIntoView({behavior:'smooth'}); document.getElementById('quantity-input').focus();" 
                            style="width: 100%; margin-top: 15px; background: rgba(255,255,255,0.05); border: 1px solid var(--accent-primary); color: var(--accent-primary); padding: 8px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s;">
                        Add to Portfolio
                    </button>
                `;
                grid.appendChild(card);

                // Render Sparkline safely
                const sparklineData = (coin.sparkline_in_7d && coin.sparkline_in_7d.price) ? coin.sparkline_in_7d.price : [];

                if (sparklineData.length > 0) {
                    const ctx = document.getElementById(`explorer-spark-${coin.id}`).getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array.from({ length: sparklineData.length }, (_, i) => i),
                            datasets: [{
                                data: sparklineData,
                                borderColor: chartColor,
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true,
                                backgroundColor: chartBg,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { enabled: false } },
                            scales: { x: { display: false }, y: { display: false } }
                        }
                    });
                } else {
                    // Fallback for missing sparkline
                    const ctx = document.getElementById(`explorer-spark-${coin.id}`).getContext('2d');
                    ctx.font = '10px Outfit';
                    ctx.fillStyle = '#888';
                    ctx.textAlign = 'center';
                    ctx.fillText('No history data', 50, 25);
                }
            });
        }

        function toggleNews(event) {
            const newsSection = document.getElementById('news-section');
            const btn = event ? event.target : document.querySelector('button[onclick*="toggleNews"]');

            if (newsSection.style.display === 'none') {
                newsSection.style.display = 'block';
                if (btn) btn.innerText = 'Hide Market News';
                newsSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                newsSection.style.display = 'none';
                if (btn) btn.innerText = 'Show Market News';
            }
        }

    </script>
</body>

</html>